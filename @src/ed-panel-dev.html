<!--
    templateType: page
    isAvailableForNewContent: false
    label: Dev Panel
    pageName: devPanel
    description: this page is not a static template, it NEEDS to run with Flask!
    author: Nicolas Mendes
-->

{% set useGlobalStyles = false %}
{% set collapseSidebar = true %}
{% extends "./_layouts/base-general-panel.html" %}
{% from './_partials/global.html' import fontsPath, scriptsPath, stylesPath %}

{# [START] page info #}
{% set page = {"pageTitle": "Developer Area | CMS Editor", "pageMeta": "Design and develop modules and templates"} %}
{# [END] page info #}

{% block title %}
  {{ page.pageTitle }}
{% endblock title %}

{% block meta %}
  {{ page.pageMeta }}
{% endblock meta %}

{% block require_css %}
  <style>
  body {
    background: #1E1E1E;
  }
  .sidebar {
    width: 90px;
  }
    .main-content {
      margin-left: 290px;
      padding: 20px;
      background: #1E1E1E;
      height: 95vh;
    }
    .main-content h1 {
      margin-top: 0;
    }

    #editor {
      width: 100%;
      height: 95vh;
      border: none;
    }

    .sidebarFiles {
  position: fixed;
  top: 0;
  left: 90px;
  width: 200px;
  height: 100vh;
  background-color: #000;
  color: #fff;
  padding: 20px;
  box-sizing: border-box;
  overflow-y: auto;
}

    .create-button {
      background-color: #fff;
      color: #000;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }

    .buttons-area {
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #595959;
      margin-bottom: 1.5rem;
    }
  </style>
{% endblock require_css %}

{% block body %}
<div class="sidebarFiles">
  <h2>Files.</h2>
  <div class="buttons-area">
    <button class="create-button" onclick="publishFile()">Publish Changes</button>
  </div>
  <ul id="file-list">

  </ul>
</div>
<div class="main-content">
  <div id="editor"></div>
  <script src="./static/engine/loader0522.js"></script>
  <link href="./static/styles/03_components/editor0522.main.min.css" rel="stylesheet">
<script>
  // Global variables to track the current file and current relative path.
  let currentFile = null;
  let currentPath = "";

  // Configure Monaco loader path.
  require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs' }});

  // Initialize the Monaco editor.
  require(['vs/editor/editor.main'], function() {
    window.editor = monaco.editor.create(document.getElementById('editor'), {
      value: '',
      language: 'python', // default language
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 18,
      roundedSelection: true,
    });
  });

  // Function to list the contents of a directory.
  function listDirectory(path) {
    fetch("{{ url_for('list_directory') }}?path=" + encodeURIComponent(path))
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          currentPath = data.path;  // Update the global currentPath.
          const fileList = document.getElementById("file-list");
          fileList.innerHTML = "";

          // If not at the root, add an entry to navigate back.
          if (data.path !== "") {
            const backItem = document.createElement("li");
            backItem.textContent = "..";
            backItem.style.cursor = "pointer";
            backItem.onclick = () => {
              // Remove the last segment from the path.
              const parts = data.path.split("/");
              parts.pop();
              const newPath = parts.join("/");
              listDirectory(newPath);
            };
            fileList.appendChild(backItem);
          }

          // List directories.
          data.directories.forEach(dir => {
            const li = document.createElement("li");
            li.textContent = dir + "/";
            li.style.cursor = "pointer";
            li.classList.add("directoryIndividual");
            li.onclick = () => {
              const newPath = data.path ? data.path + "/" + dir : dir;
              listDirectory(newPath);
            };
            fileList.appendChild(li);
          });

          // List files.
          data.files.forEach(file => {
            const li = document.createElement("li");
            li.textContent = file;
            li.style.cursor = "pointer";
            li.onclick = () => loadFileContent(file, data.path);
            fileList.appendChild(li);
          });
        } else {
          alert("Error listing directory: " + data.message);
        }
      });
  }

  // Function to determine Monaco language based on file extension.
  function getLanguageFromFileName(fileName) {
    const parts = fileName.split('.');
    if (parts.length < 2) return 'plaintext';
    const extension = parts.pop().toLowerCase();
    switch(extension) {
      case 'js': return 'javascript';
      case 'py': return 'python';
      case 'html': return 'twig';  // or 'html'
      case 'css': return 'css';
      case 'json': return 'json';
      case 'md': return 'markdown';
      default: return 'plaintext';
    }
  }

  // Load file content into the editor.
  // Pass the current directory path along.
  function loadFileContent(file, path) {
    currentFile = file;
    currentPath = path;  // Ensure the current path is updated.
    fetch("{{ url_for('file_content') }}?file=" + encodeURIComponent(file) +
          "&path=" + encodeURIComponent(path))
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          const language = getLanguageFromFileName(file);
          monaco.editor.setModelLanguage(window.editor.getModel(), language);
          window.editor.setValue(data.content);
        } else {
          alert("Error loading file: " + data.message);
        }
      });
  }

  // Publish changes: send the current file, its content, and the current path.
  function publishFile() {
    if (!currentFile) {
      alert("No file loaded to publish.");
      return;
    }
    const content = window.editor.getValue();
    fetch("{{ url_for('publish_file') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ file: currentFile, content: content, path: currentPath })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        alert("File published successfully!");
      } else {
        alert("Error publishing file: " + data.message);
      }
    })
    .catch(err => {
      alert("Error: " + err);
    });
  }

  // On page load, list the root directory.
  window.onload = function() {
    listDirectory("");
  };
</script>
</div>
{% endblock body %}
