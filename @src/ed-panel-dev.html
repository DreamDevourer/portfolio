<!--
    templateType: page
    isAvailableForNewContent: false
    label: Dev Panel
    pageName: devPanel
    description: this page is not a static template, it NEEDS to run with Flask!
    author: Nicolas Mendes
-->

{% set useGlobalStyles = false %}
{% extends "./_layouts/base-general-panel.html" %}
{% from './_partials/global.html' import fontsPath, scriptsPath, stylesPath %}

{# [START] page info #}
{% set page = {"pageTitle": "Developer Area | CMS Editor", "pageMeta": "Design and develop modules and templates"} %}
{# [END] page info #}

{% block title %}
  {{ page.pageTitle }}
{% endblock title %}

{% block meta %}
  {{ page.pageMeta }}
{% endblock meta %}

{% block require_css %}
  <style>
    .main-content {
      margin-left: 395px;
      padding: 20px;
      background: #1E1E1E;
      height: 100vh;
    }
    .main-content h1 {
      margin-top: 0;
    }

    #editor {
      width: 100%;
      height: 90vh;
      border: none;
    }

    .sidebarFiles {
  position: fixed;
  top: 0;
  left: 198px;
  width: 200px;
  height: 100vh;
  background-color: #000;
  color: #fff;
  padding: 20px;
  box-sizing: border-box;
  overflow-y: auto;
}

ul#file-list {
  list-style: none;
  list-style-type: none;
  padding: 0;
}

#file-list li {
  margin: 15px 0;
  list-style: none;
  list-style-type: none;
}

{# add file icon #}
#file-list li::before {
  content: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxNCAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEzLjY2NjYgNi4wMDAwOEg5LjY2NjY1QzkuMzEzMDIgNi4wMDAwOCA4Ljk3Mzg5IDUuODU5NjEgOC43MjM4NCA1LjYwOTU2QzguNDczNzkgNS4zNTk1MSA4LjMzMzMxIDUuMDIwMzcgOC4zMzMzMSA0LjY2Njc1VjAuNjY2NzQ4SDEuNjY2NjVDMS4zMTMwMiAwLjY2Njc0OCAwLjk3Mzg4NiAwLjgwNzIyNCAwLjcyMzgzNyAxLjA1NzI3QzAuNDczNzg5IDEuMzA3MzIgMC4zMzMzMTMgMS42NDY0NiAwLjMzMzMxMyAyLjAwMDA4VjEwLjAwMDFDMC4zMzMzMTMgMTAuMzUzNyAwLjQ3Mzc4OSAxMC42OTI4IDAuNzIzODM3IDEwLjk0MjlDMC45NzM4ODYgMTEuMTkyOSAxLjMxMzAyIDExLjMzMzQgMS42NjY2NSAxMS4zMzM0SDEyLjMzMzNDMTIuNjg2OSAxMS4zMzM0IDEzLjAyNjEgMTEuMTkyOSAxMy4yNzYxIDEwLjk0MjlDMTMuNTI2MiAxMC42OTI4IDEzLjY2NjYgMTAuMzUzNyAxMy42NjY2IDEwLjAwMDFWNi4wMDAwOFpNMTMuMzMzMyA1LjAwMDA4SDkuNjY2NjVDOS41NzgyNCA1LjAwMDA4IDkuNDkzNDYgNC45NjQ5NiA5LjQzMDk0IDQuOTAyNDVDOS4zNjg0MyA0LjgzOTk0IDkuMzMzMzEgNC43NTUxNSA5LjMzMzMxIDQuNjY2NzVWMS4wMDAwOEwxMy4zMzMzIDUuMDAwMDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K");
  width: 1rem;
  height: 1rem;
  margin-right: 10px;
}

    .create-button {
      background-color: #fff;
      color: #000;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }

    .buttons-area {
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #595959;
      margin-bottom: 1.5rem;
    }
  </style>
{% endblock require_css %}

{% block body %}
<div class="sidebarFiles">
  <h2>Files.</h2>
  <div class="buttons-area">
    <button class="create-button" onclick="publishFile()">Publish Changes</button>
  </div>
  <ul id="file-list">

  </ul>
</div>
<div class="main-content">
  <div id="editor"></div>
  <script src="./static/engine/loader0522.js"></script>
  <link href="./static/styles/03_components/editor0522.main.min.css" rel="stylesheet">
<script>
  // Global variable to keep track of the currently loaded file.
  let currentFile = null;

  // Configure the path for the Monaco editor
  require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs' }});

  // Load the Monaco editor
  require(['vs/editor/editor.main'], function() {
    // Create the editor instance and store it in a global variable
    window.editor = monaco.editor.create(document.getElementById('editor'), {
      value: '',
      language: 'python', // default language
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 18,
      roundedSelection: true,
    });
  });

  // Fetch and display the list of files
  fetch("{{ url_for('list_files') }}")
    .then(response => response.json())
    .then(data => {
      if(data.status === "success") {
        const fileList = document.getElementById("file-list");
        data.files.forEach(file => {
          const li = document.createElement("li");
          li.textContent = file;
          li.style.cursor = "pointer";
          li.onclick = () => loadFileContent(file);
          fileList.appendChild(li);
        });
      }
    });

  // Function to map file extensions to Monaco language identifiers
  function getLanguageFromFileName(fileName) {
    const parts = fileName.split('.');
    if (parts.length < 2) return 'plaintext';
    const extension = parts.pop().toLowerCase();
    switch(extension) {
      case 'js': return 'javascript';
      case 'py': return 'python';
      case 'html': return 'twig'; // or 'html'
      case 'css': return 'css';
      case 'json': return 'json';
      case 'md': return 'markdown';
      default: return 'plaintext';
    }
  }

  // Load file content into the Monaco editor and update the language dynamically
  function loadFileContent(file) {
    // Set the current file
    currentFile = file;
    fetch("{{ url_for('file_content') }}?file=" + encodeURIComponent(file))
      .then(response => response.json())
      .then(data => {
        if(data.status === "success") {
          // Determine the correct language from the file name
          var language = getLanguageFromFileName(file);
          // Update the model's language
          monaco.editor.setModelLanguage(window.editor.getModel(), language);
          // Set the editor content
          window.editor.setValue(data.content);
        } else {
          alert("Error loading file: " + data.message);
        }
      });
  }

  // Publish changes by sending the current file and editor content to the backend
  function publishFile() {
    if (!currentFile) {
      alert("No file loaded to publish.");
      return;
    }
    const content = window.editor.getValue();
    fetch("{{ url_for('publish_file') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ file: currentFile, content: content })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        alert("File published successfully!");
      } else {
        alert("Error publishing file: " + data.message);
      }
    })
    .catch(err => {
      alert("Error: " + err);
    });
  }
</script>
</div>
{% endblock body %}
