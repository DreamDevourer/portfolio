<!--
    templateType: page
    isAvailableForNewContent: false
    label: Editor UI
    pageName: editor
    description: this page is not a static template, it NEEDS to run with Flask!
    author: Nicolas Mendes
-->

<!-- References: https://github.com/Ju99ernaut/grapesjs-plugin-toolbox?tab=readme-ov-file and https://codepen.io/ju99ernaut/pen/Vwaqdpw -->


{% set editorInternalDirectory = true %}
{% extends "./_layouts/base-editor.html" %}
{% from './_partials/global.html' import fontsPath, scriptsPath, stylesPath %}

{# [START] page info #}
{% set page = {"pageTitle": "Editing | CMS Editor", "pageMeta": "Editing a page from the CMS"} %}
{# [END] page info #}

{% block title %}
{{ page.pageTitle }}
{% endblock title %}

{% block meta %}
{{ page.pageMeta }}
{% endblock meta %}


{% block body %}
        <link rel="stylesheet" href="../../static/styles/03_components/grapes.min.css" />
        <link rel="stylesheet"
              href="../../static/styles/03_components/grapesjs-plugin-toolbox.min.css" />
        <link rel="stylesheet"
              href="../../static/styles/03_components/grapesjs-rulers.min.css" />
        <link rel="stylesheet"
              href="../../static/styles/03_components/font-awesome470.min.css" />
        <script src="../../static/engine/grapes.min.js"></script>


        <script src="../../static/engine/grapesjs-plugin-export.js"></script>
        <script src="../../static/engine/grapesjs-parser-postcss.js"></script>
        <script src="../../static/engine/grapesjs-custom-code.js"></script>
        <script src="../../static/engine/grapesjs-plugin-toolbox.min.js"></script>
        <script src="../../static/engine/grapesjs-rulers.min.js"></script>

        <script>
    document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
            var stylesInjection = document.getElementById("styles-injection");
            if (stylesInjection) {
                // Add a new class to stylesInjection called 'initialStyleLoaded'
                stylesInjection.classList.add("initialStyleLoaded");

                // Wait until the GrapesJS iframe is fully loaded
                var iframe = document.querySelector(".gjs-frame");
                if (iframe) {
                    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    // Clone the stylesInjection and append it to the iframe's body
                    iframeDoc.body.appendChild(stylesInjection.cloneNode(true));

                    // Remove the class 'initialStyleLoaded' from the cloned stylesInjection inside the iframe
                    var clonedStylesInjection = iframeDoc.querySelector("#styles-injection");
                    if (clonedStylesInjection) {
                        clonedStylesInjection.classList.remove("initialStyleLoaded");
                    }

                    // Remove the original element with the class 'initialStyleLoaded' outside the iframe
                    var initialStyleLoaded = document.querySelector(".initialStyleLoaded");
                    if (initialStyleLoaded) {
                        initialStyleLoaded.remove();
                    }
                }
            }
        }, 500);
    });
        </script>

        <link rel="stylesheet" href="../../static/styles/03_components/editor-internal.css" />

<section class="top-header-area">
  <div class="top-header-left">
    <a data-button-use="secondary-ghost" aria-disabled="false" href="/" tabindex="0" class="PrivateButtonLink__StyledButtonLink-sc-1vuooyw-1 FNmEc adapto-exit_btn">
      Exit
    </a>
    <nav class="top-header-nav">
      <!-- Dropdowns: File, Edit and Settings -->
      <div class="top-header-nav__container">
      <button class="top-header-nav__button">File</button>
      <ul class="top-header-nav__file">
        <li class="top-header-nav__file__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="saveProjectData()">Save</button>
        </li>
        <li class="top-header-nav__file__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="">Clone (Comming soon)</button>
        </li>
        <li class="top-header-nav__file__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="previewTemplate()">Preview</button>
        </li>
        <li class="top-header-nav__file__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="window.location.href = '/';">Exit</button>
        </li>
      </ul>
      </div>

<div class="top-header-nav__container">
      <button class="top-header-nav__button">Edit</button>
      <ul class="top-header-nav__edit">
        <li class="top-header-nav__edit__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="undoTemplate()">Undo</button>
        </li>
        <li class="top-header-nav__edit__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="redoTemplate()">Redo</button>
        </li>
      </ul>
      </div>

<div class="top-header-nav__container">
      <button class="top-header-nav__button">Settings</button>
      <ul class="top-header-nav__settings">
        <li class="top-header-nav__settings__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="window.location.href = '/';">General (Comming soon)</button>
        </li>
        <li class="top-header-nav__settings__item">
          <button class="top-header-nav__file__item__link button small-cta grocom-case-cta" onclick="exportTemplate()">View Source</button>
        </li>
      </ul>
      </div>
    </nav>
  </div>

  <div class="top-header-center">
    <a href="/"><svg width="32" height="71" viewBox="0 0 32 71" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M15.4284 58.5866C7.21558 58.5866 1.40792 52.5443 1.40792 44.5075C1.40792 36.2946 7.21558 30.4283 15.4284 30.4283C23.5826 30.4283 29.3903 36.2946 29.3903 44.5075C29.3903 52.5443 23.5826 58.5866 15.4284 58.5866ZM15.4284 50.6084C18.8896 50.6084 21.1188 47.9686 21.1188 44.5075C21.1188 41.0463 18.8896 38.4651 15.4284 38.4651C11.9086 38.4651 9.62077 41.0463 9.62077 44.5075C9.62077 47.9686 11.9086 50.6084 15.4284 50.6084Z" fill="white"/>
<circle cx="25.6471" cy="27.3568" r="6.35294" fill="#1A2EEB"/>
</svg>
</a>
</div>

    <div class="top-header-right">
        <button class="top-header-right__button preview-btn" onclick="previewTemplate()">Preview</button>
    </div>
</section>

        <!-- 1️⃣ Main -->
        <main class="summary--area-controller">

            <div id="styles-injection">
                <style>
            @font-face {
                font-family: Canela;
                src: url('../../static/fonts/Selected/Canela.woff2') format('woff2');
                font-display: swap;
            }

            @font-face {
                font-family: CanelaThin;
                src: url('../../static/fonts/Selected/Canela-Thin-Trial.woff2') format('woff2');
                font-display: swap;
            }

            @font-face {
                font-family: CanelaThinItalic;
                src: url('../../static/fonts/Selected/Canela-ThinItalic-Trial.woff2') format('woff2');
                font-display: swap;
            }
                </style>

                <link rel="preconnect" href="https://fonts.googleapis.com" />
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
                <link href="https://fonts.googleapis.com/css2?family=Oxygen:wght@200;300;400;700&family=Work+Sans:wght@100;200;300;400;500;600;700;900&display=swap"
                      rel="stylesheet" />

                <style>{% include "./static/styles/compiled/master.css" %}</style>
            </div>

            <div id="editor"></div>

            <script>
        const editor = grapesjs.init({
            container: '#editor',
            fromElement: true,
            height: 'calc(100vh - 80px)',
            width: '100%',
            storageManager: {
                type: 'remote',
                urlStore: 'http://127.0.0.1:5000/save-json',
                urlLoad: 'http://127.0.0.1:5000/load-json/{{ page_name|default("default") }}',
                autosave: true,
                autoload: true,
                stepsBeforeSave: 1,
                storeComponents: true,
                storeStyles: true,
            },
            plugins: ["grapesjs-plugin-export", "grapesjs-parser-postcss", "grapesjs-custom-code", "grapesjs-plugin-toolbox", "grapesjs-rulers"],
            pluginsOpts: {
                "grapesjs-plugin-toolbox": {
                    panels: true
                }
            },
            blockManager: {
                blocks: [
                    {
                        id: 'module__hero-gen2.html',
                        label: '<b>Hero Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/module__hero-gen2.html" %}`,
                    },
                    {
                        id: 'hubdb__module__test.html',
                        label: '<b>HubDB Test Module</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/hubdb__module__test.html" %}`,
                    },
                    {
                        id: 'module__hero.html',
                        label: '<b>Hero Legacy Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/module__hero.html" %}`,
                    },
                    {
                        id: 'module__contained-text.html',
                        label: '<b>Contained Text Wall</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/module__contained-text.html" %}`,
                    },
                    {
                        id: 'module__quote.html',
                        label: '<b>Motto Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-quote-left' },
                        content: `{% include "./_modules/module__quote.html" %}`,
                    },
                    {
                        id: 'module__summary.html',
                        label: '<b>Summary Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-sticky-note' },
                        content: `{% include "./_modules/module__summary.html" %}`,
                    },
                    {
                        id: 'module__carousel.html',
                        label: '<b>Carousel Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-columns' },
                        content: `{% include "./_modules/module__carousel.html" %}`,
                    },
                    {
                        id: 'module__get_in_touch.html',
                        label: '<b>Get In Touch CTA</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-square' },
                        content: `{% include "./_modules/module__get_in_touch.html" %}`,
                    }, 
                    {
                        id: 'module__testimonials.html',
                        label: '<b>Testimonials</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-commenting' },
                        content: `{% include "./_modules/module__testimonials.html" %}`,
                    },
                    {
                        id: 'text',
                        label: 'Text',
                        category: "Basic",
                        attributes: { class:'fa fa-pencil-square' },
                        content: '<div data-gjs-type="text">Insert your text here</div>',
                    }, {
                        id: 'image',
                        label: 'Image',
                        select: true,
                        category: "Basic",
                        attributes: { class:'fa fa-picture-o' },
                        content: { type: 'image' },
                        activate: true,
                    }
                ]
            },
        });

        const pm = editor.Pages;

        const pn = editor.Panels;
        const panelViews = pn.addPanel({
            id: "options"
        });
        panelViews.get("buttons").add([
            {
                attributes: {
                    title: "Toggle Rulers"
                },
                label: `<svg width="18" viewBox="0 0 16 16"><path d="M0 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H.5A.5.5 0 0 1 0 8z" /><path d="M4 3h8a1 1 0 0 1 1 1v2.5h1V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2.5h1V4a1 1 0 0 1 1-1zM3 9.5H2V12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9.5h-1V12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z" /></svg>`,
                command: "ruler-visibility",
                id: "ruler-visibility"
            }
        ]);
        {# panelViews.get("buttons").remove("save-page"); #}

function copyProjectData() {
    var projectData = editor.getProjectData();
    var projectDataStr = JSON.stringify(projectData);

    const blocksCollection = JSON.stringify(editor.BlockManager.getAllVisible());

    const allComponents = JSON.stringify(editor.getComponents());

    const wrapper = editor.getWrapper();
    const elX = wrapper.find('#module__hero-gen2.html')[0];

    console.log(`Saving Project Data: ${projectDataStr}`); 
    console.log(`Saving blocksCollection Data: ${blocksCollection}`);
    console.log(`Saving allComponents Data: ${allComponents}`); 
    console.log(`Who is elX: ${JSON.stringify(elX)}`); 

    // Send the JSON data to the Flask server
    fetch('/save-json', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: projectDataStr,
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message);
    })
    .catch(error => {
        console.error('Error saving project data:', error);
    });
}

    

function saveProjectData() {
    var projectData = editor.getProjectData();
    var projectHTML = editor.getHtml();
    var projectCSS = editor.getCss();

    console.log(`projectHTML: ${projectHTML} and projectCSS: ${projectCSS}`);

    if (!projectData.pageName) {
        projectData.pageName = "{{ page_name|default('default') }}";
    }
    var payload = {
        projectData: projectData,
        projectHTML: projectHTML,
        projectCSS: projectCSS
    };
    var payloadStr = JSON.stringify(payload);
    console.log("Saving Project Data: " + payloadStr);
    fetch('/save-json', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: payloadStr,
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message);
        alert("Page saved successfully: " + data.message);
    })
    .catch(error => {
        console.error('Error saving project data:', error);
        alert("Error saving page data");
    });
}
    
function exportUsedBlocks() {
    // Get all available block IDs from the BlockManager
    const allBlocksCollection = editor.BlockManager.getAllVisible();
    const availableBlockIds = [];
    allBlocksCollection.each(block => {
        availableBlockIds.push(block.get('id'));
    });
    
    // Find all elements in the canvas that have an id attribute
    const usedElements = editor.getWrapper().find('[id]');
    const usedElementIds = usedElements.map(el => el.getAttributes().id).filter(id => id);
    
    // Filter available block IDs to include only those present in the canvas
    const usedBlocks = availableBlockIds.filter(id => usedElementIds.includes(id));
    
    const usedBlocksJson = JSON.stringify(usedBlocks, null, 2);
    console.log("Used Blocks JSON:", usedBlocksJson);
    
    return usedBlocksJson;
}



function loadProjectData() {
    var pageName = document.getElementById("w3review").value; // Assume this contains the page name

    fetch(`/load_json/${pageName}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            editor.loadProjectData(data.data);
        } else {
            console.error(data.message);
        }
    })
    .catch(error => {
        console.error('Error loading project data:', error);
    });
}

    function exportTemplate() {
        editor.runCommand('export-template');
    }

    function previewTemplate() {
        editor.runCommand('preview')
    }

    function undoTemplate() {
  editor.UndoManager.undo(1);
}

function redoTemplate() {
  editor.UndoManager.redo(1);
}

// DOMContentLoaded
document.addEventListener("DOMContentLoaded", function () {

    console.log(`All available commands: ${JSON.stringify(editor.Commands.getAll())}`);
    console.log(`test getProjectData() ${JSON.stringify(editor.getProjectData())}`);

                // Make an API call to fetch the project JSON data for the current page with improved error handling
            fetch(`/load-json/{{ page_name|default("default") }}`)
              .then(response => {
                  if (!response.ok) {
                      return response.text().then(text => {
                          throw new Error("HTTP error " + response.status + ": " + text);
                      });
                  }
                  return response.json();
              })
              .then(data => {
                  console.log("Loaded project data from API");
                  console.log(`received data: ${JSON.stringify(data)}`);
                  editor.loadProjectData(data);
              })
              .catch(error => {
                  console.error("Error loading project data:", error);
              });

              // change opacity of <main> to 1 after 1000ms
                setTimeout(function () {
                    document.querySelector("main").style.opacity = 1;
                    document.querySelector("main").style.transform = "translateY(0)";
                    document.querySelector(".top-header-area").style.opacity = 1;
                    document.querySelector(".top-header-area").style.transform = "translateY(0)";
                }, 500);
});
            </script>
        </main>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Loading top header functions");
    // Query all top-header navigation buttons
    const navButtons = document.querySelectorAll('.top-header-nav__button');

    navButtons.forEach(button => {
      button.addEventListener('click', function (e) {
        // Prevent the click from propagating to the document listener
        e.stopPropagation();

        // First, close all dropdowns except the one for this button
        document.querySelectorAll('.top-header-nav ul').forEach(ul => {
          if (ul !== button.nextElementSibling) {
            ul.style.display = 'none';
          }
        });

        // Toggle the dropdown (assumes the next sibling is the matching <ul>)
        const dropdown = button.nextElementSibling;
        if (dropdown) {
          // Toggle display style between "block" and "none"
          dropdown.style.display = (dropdown.style.display === 'flex') ? 'none' : 'flex';
        }
      });
    });

    // Close any open dropdown if clicking outside of the nav area
    document.addEventListener('click', function () {
      document.querySelectorAll('.top-header-nav ul').forEach(ul => {
        ul.style.display = 'none';
      });
    });
  });
</script>
{% endblock body %}
