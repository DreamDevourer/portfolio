<!--
    templateType: page
    isAvailableForNewContent: false
    label: Editor UI
    pageName: editor
    description: this page is not a static template, it NEEDS to run with Flask!
    author: Nicolas Mendes
-->

<!-- References: https://github.com/Ju99ernaut/grapesjs-plugin-toolbox?tab=readme-ov-file and https://codepen.io/ju99ernaut/pen/Vwaqdpw -->

<!-- TODO:
    - Implement the page creation UI options, such as title, meta description, header type and others...
    - Implement a list where it shows all json files available, then after selecting one, you can load the editor
    - We probably want to have a separated json like this "page-name-options.json" alongside with "page-name.json", where "page-name-options.json" will going to be the page creation UI options and "page-name.json" will just be generated by grapesjs...
-->


{% from './_partials/global.html' import fontsPath, scriptsPath, stylesPath, imagesPath %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex" />
        <title>Editor</title>
    </head>
    <body>

        <link rel="stylesheet" href="./static/styles/03_components/grapes.min.css" />
        <link rel="stylesheet"
              href="./static/styles/03_components/grapesjs-plugin-toolbox.min.css" />
        <link rel="stylesheet"
              href="./static/styles/03_components/grapesjs-rulers.min.css" />
        <script src="./static/engine/grapes.min.js"></script>


        <script src="./static/engine/grapesjs-plugin-export.js"></script>
        <script src="./static/engine/grapesjs-parser-postcss.js"></script>
        <script src="./static/engine/grapesjs-custom-code.js"></script>
        <script src="./static/engine/grapesjs-plugin-toolbox.min.js"></script>
        <script src="./static/engine/grapesjs-rulers.min.js"></script>

        <script>
    document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
            var stylesInjection = document.getElementById("styles-injection");
            if (stylesInjection) {
                // Add a new class to stylesInjection called 'initialStyleLoaded'
                stylesInjection.classList.add("initialStyleLoaded");

                // Wait until the GrapesJS iframe is fully loaded
                var iframe = document.querySelector(".gjs-frame");
                if (iframe) {
                    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    // Clone the stylesInjection and append it to the iframe's body
                    iframeDoc.body.appendChild(stylesInjection.cloneNode(true));

                    // Remove the class 'initialStyleLoaded' from the cloned stylesInjection inside the iframe
                    var clonedStylesInjection = iframeDoc.querySelector("#styles-injection");
                    if (clonedStylesInjection) {
                        clonedStylesInjection.classList.remove("initialStyleLoaded");
                    }

                    // Remove the original element with the class 'initialStyleLoaded' outside the iframe
                    var initialStyleLoaded = document.querySelector(".initialStyleLoaded");
                    if (initialStyleLoaded) {
                        initialStyleLoaded.remove();
                    }
                }
            }
        }, 500);
    });
        </script>

        <!-- 1️⃣ Main -->
        <main class="summary--area-controller">

            <div id="styles-injection">
                <style>
            @font-face {
                font-family: Canela;
                src: url('./static/fonts/Selected/Canela.woff2') format('woff2');
                font-display: swap;
            }

            @font-face {
                font-family: CanelaThin;
                src: url('./static/fonts/Selected/Canela-Thin-Trial.woff2') format('woff2');
                font-display: swap;
            }

            @font-face {
                font-family: CanelaThinItalic;
                src: url('./static/fonts/Selected/Canela-ThinItalic-Trial.woff2') format('woff2');
                font-display: swap;
            }
                </style>

                <link rel="preconnect" href="https://fonts.googleapis.com" />
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
                <link href="https://fonts.googleapis.com/css2?family=Oxygen:wght@200;300;400;700&family=Work+Sans:wght@100;200;300;400;500;600;700;900&display=swap"
                      rel="stylesheet" />

                <style>{% include "./static/styles/compiled/master.css" %}</style>
            </div>

            <div id="editor"></div>

            <div id="loadEditorJson" style="padding-bottom: 3rem;">
                <button class="button small-cta grocom-case-cta" onclick="copyProjectData()">Copy Editor JSON</button>
                <br />
                <button class="button small-cta grocom-case-cta" onclick="exportData()">Export Page</button>

                <br />
                <br />

                <textarea id="w3review" name="w3review" rows="4" cols="50"></textarea>
                <br />
                <button class="button small-cta grocom-case-cta" onclick="loadProjectData()">Load JSON</button>
            </div>

            <script>
        const editor = grapesjs.init({
            container: '#editor',
            fromElement: true,
            height: '100vh',
            width: '100%',
            storageManager: true,
            storageManager: {
                type: 'local',
                autosave: true,
                autoload: true,
                stepsBeforeSave: 1,
            },
            plugins: ["grapesjs-plugin-export", "grapesjs-parser-postcss", "grapesjs-custom-code", "grapesjs-plugin-toolbox", "grapesjs-rulers"],
            pluginsOpts: {
                "grapesjs-plugin-toolbox": {
                    panels: true
                }
            },
            blockManager: {
                blocks: [
                    {
                        id: 'module__hero-gen2.html',
                        label: '<b>Hero Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/module__hero-gen2.html" %}`,
                    },
                    {
                        id: 'module__hero.html',
                        label: '<b>Hero Legacy Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/module__hero.html" %}`,
                    },
                    {
                        id: 'module__contained-text.html',
                        label: '<b>Contained Text Wall</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-address-card' },
                        content: `{% include "./_modules/module__contained-text.html" %}`,
                    },
                    {
                        id: 'module__quote.html',
                        label: '<b>Motto Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-quote-left' },
                        content: `{% include "./_modules/module__quote.html" %}`,
                    },
                    {
                        id: 'module__summary.html',
                        label: '<b>Summary Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-sticky-note' },
                        content: `{% include "./_modules/module__summary.html" %}`,
                    },
                    {
                        id: 'module__carousel.html',
                        label: '<b>Carousel Section</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-columns' },
                        content: `{% include "./_modules/module__carousel.html" %}`,
                    },
                    {
                        id: 'module__get_in_touch.html',
                        label: '<b>Get In Touch CTA</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-square' },
                        content: `{% include "./_modules/module__get_in_touch.html" %}`,
                    }, 
                    {
                        id: 'module__testimonials.html',
                        label: '<b>Testimonials</b>',
                        category: "Sections",
                        attributes: { class:'gjs-block-section fa fa-commenting' },
                        content: `{% include "./_modules/module__testimonials.html" %}`,
                    },
                    {
                        id: 'text',
                        label: 'Text',
                        category: "Basic",
                        attributes: { class:'fa fa-pencil-square' },
                        content: '<div data-gjs-type="text">Insert your text here</div>',
                    }, {
                        id: 'image',
                        label: 'Image',
                        select: true,
                        category: "Basic",
                        attributes: { class:'fa fa-picture-o' },
                        content: { type: 'image' },
                        activate: true,
                    }
                ]
            },
        });

        const pn = editor.Panels;
        const panelViews = pn.addPanel({
            id: "options"
        });
        panelViews.get("buttons").add([
            {
                attributes: {
                    title: "Toggle Rulers"
                },
                label: `<svg width="18" viewBox="0 0 16 16"><path d="M0 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H.5A.5.5 0 0 1 0 8z" /><path d="M4 3h8a1 1 0 0 1 1 1v2.5h1V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2.5h1V4a1 1 0 0 1 1-1zM3 9.5H2V12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9.5h-1V12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z" /></svg>`,
                command: "ruler-visibility",
                id: "ruler-visibility"
            }
        ]);

        editor.on('load', (some, argument) => {
            console.log('Editor fully loaded!')
            const blockBtn = editor.Panels.getButton('views', 'open-blocks');
            blockBtn.set('active', 1);
        })

function copyProjectData() {
    var projectData = editor.getProjectData();
    var projectDataStr = JSON.stringify(projectData);

    console.log("Saving Project Data:", projectDataStr);  // Debug: Check the data being sent

    // Send the JSON data to the Flask server
    fetch('/save-json', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: projectDataStr,
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message);
    })
    .catch(error => {
        console.error('Error saving project data:', error);
    });
}



function loadProjectData() {
    var pageName = document.getElementById("w3review").value; // Assume this contains the page name

    fetch(`/load_json/${pageName}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            editor.loadProjectData(data.data);
        } else {
            console.error(data.message);
        }
    })
    .catch(error => {
        console.error('Error loading project data:', error);
    });
}


        function exportData() {
            editor.runCommand('page-export-zip');
        }
            </script>
        </main>
    </body>
</html>
